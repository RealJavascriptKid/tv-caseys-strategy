//@version=5
indicator("Casey's Strategy implemented by SaadPro", overlay=true, max_boxes_count=500, max_lines_count=500)

// --- Inputs ---
pm_session = input.session("0400-0930", "Premarket Time")
yd_session = input.session("0930-1600", "Regular Session Time")
tf_input   = input.timeframe("15", "Zone Calculation Timeframe")

show_pm   = input.bool(true, "Show Premarket (PMH/L)")
show_yd   = input.bool(true, "Show Yesterday (PDH/L)")
show_dby  = input.bool(true, "Show Day Before Yesterday (DBPH/L)")

use_next_candle = input.bool(true, "Use Next higher Timeframe Candle Body for Zone (instead of current body)")

pm_color    = input.color(color.rgb(53, 136, 209), "Premarket Color")
yd_color    = input.color(color.rgb(53, 136, 209), "Yesterday Color")
dby_color   = input.color(color.rgb(53, 136, 209), "DBY Color")
zone_transp = input.int(90, "Zone Transparency", minval=0, maxval=100)

// --- EMA Settings ---
show_ema13 = input.bool(false, "EMA 13", group="EMA 13", inline="ema13")
ema13_color = input.color(color.yellow, "", group="EMA 13", inline="ema13")
ema13_width = input.int(2, "", minval=1, maxval=4, group="EMA 13", inline="ema13")

show_ema48 = input.bool(false, "EMA 48", group="EMA 48", inline="ema48")
ema48_color = input.color(#641864, "", group="EMA 48", inline="ema48")
ema48_width = input.int(2, "", minval=1, maxval=4, group="EMA 48", inline="ema48")

show_ema200 = input.bool(false, "EMA 200", group="EMA 200", inline="ema200")
ema200_color = input.color(#892828, "", group="EMA 200", inline="ema200")
ema200_width = input.int(2, "", minval=1, maxval=4, group="EMA 200", inline="ema200")

// --- Calculate EMAs ---
ema13 = ta.ema(close, 13)
ema48 = ta.ema(close, 48)
ema200 = ta.ema(close, 200)

// --- Plot EMAs ---
plot(show_ema13 ? ema13 : na, "EMA 13", ema13_color, ema13_width)
plot(show_ema48 ? ema48 : na, "EMA 48", ema48_color, ema48_width)
plot(show_ema200 ? ema200 : na, "EMA 200", ema200_color, ema200_width)

// --- MTF Data (only what we need) ---
[mtf_open, mtf_close] = request.security(syminfo.tickerid, tf_input, [open, close], lookahead=barmerge.lookahead_on)

// --- How many chart bars in one MTF candle? ---
chart_tf_sec  = timeframe.in_seconds(timeframe.period)
mtf_tf_sec    = timeframe.in_seconds(tf_input)
bars_per_mtf  = math.floor(mtf_tf_sec / chart_tf_sec)

// --- Storage Variables ---
var float c_h = na, var int c_h_idx = na, var float c_body_h = na
var float c_l = na, var int c_l_idx = na, var float c_body_l = na
var float y_h = na, var int y_h_idx = na, var float y_body_h = na
var float y_l = na, var int y_l_idx = na, var float y_body_l = na
var float dby_h = na, var int dby_h_idx = na, var float dby_body_h = na
var float dby_l = na, var int dby_l_idx = na, var float dby_body_l = na
var float pm_h = na, var int pm_h_idx = na
var float pm_l = na, var int pm_l_idx = na

// --- Pending trackers (only for "next candle" mode) ---
var bool  c_pending_h = false, var int  c_pending_h_idx = na
var bool  c_pending_l = false, var int  c_pending_l_idx = na
var bool  y_pending_h = false, var int  y_pending_h_idx = na
var bool  y_pending_l = false, var int  y_pending_l_idx = na
var bool dby_pending_h = false, var int dby_pending_h_idx = na
var bool dby_pending_l = false, var int dby_pending_l_idx = na

// --- Session Detection (New York) ---
is_pm = not na(time(timeframe.period, pm_session, "America/New_York"))
is_yd = not na(time(timeframe.period, yd_session, "America/New_York"))

// --- Helper: resolve pending bodies using bar count ---
f_resolve_pending(_pending, _stored_idx) =>
    if _pending and not na(_stored_idx)
        if bar_index - _stored_idx >= bars_per_mtf
            // Exactly one MTF candle has passed → use the *current* MTF body (which is the body of the "next" candle)
            [true]   // ready to assign
        else
            [false]  // still waiting
    else
        [false]

// --- RESOLVE ALL PENDING UPDATES (every bar) ---
// Current Day
if c_pending_h
    [ready_h] = f_resolve_pending(c_pending_h, c_pending_h_idx)
    if ready_h
        c_body_h := math.max(mtf_open, mtf_close)
        c_pending_h := false
if c_pending_l
    [ready_l] = f_resolve_pending(c_pending_l, c_pending_l_idx)
    if ready_l
        c_body_l := math.min(mtf_open, mtf_close)
        c_pending_l := false

// Yesterday
if y_pending_h
    [ready_h] = f_resolve_pending(y_pending_h, y_pending_h_idx)
    if ready_h
        y_body_h := math.max(mtf_open, mtf_close)
        y_pending_h := false
if y_pending_l
    [ready_l] = f_resolve_pending(y_pending_l, y_pending_l_idx)
    if ready_l
        y_body_l := math.min(mtf_open, mtf_close)
        y_pending_l := false

// DBY
if dby_pending_h
    [ready_h] = f_resolve_pending(dby_pending_h, dby_pending_h_idx)
    if ready_h
        dby_body_h := math.max(mtf_open, mtf_close)
        dby_pending_h := false
if dby_pending_l
    [ready_l] = f_resolve_pending(dby_pending_l, dby_pending_l_idx)
    if ready_l
        dby_body_l := math.min(mtf_open, mtf_close)
        dby_pending_l := false

// --- Premarket & Shift ---
if is_pm
    if not is_pm[1]
        // Force‑resolve any pending Current Day before shifting
        if c_pending_h
            c_body_h := math.max(mtf_open, mtf_close)
            c_pending_h := false
        if c_pending_l
            c_body_l := math.min(mtf_open, mtf_close)
            c_pending_l := false
        
        dby_h := y_h, dby_h_idx := y_h_idx, dby_body_h := y_body_h
        dby_l := y_l, dby_l_idx := y_l_idx, dby_body_l := y_body_l
        
        y_h := c_h, y_h_idx := c_h_idx, y_body_h := c_body_h
        y_l := c_l, y_l_idx := c_l_idx, y_body_l := c_body_l
        
        pm_h := high, pm_h_idx := bar_index
        pm_l := low,  pm_l_idx := bar_index
    else
        if high >= pm_h
            pm_h := high, pm_h_idx := bar_index
        if low <= pm_l
            pm_l := low,  pm_l_idx := bar_index

// --- Regular Session ---
if is_yd
    if not is_yd[1]
        c_h := high
        c_h_idx := bar_index
        c_l := low
        c_l_idx := bar_index
        
        if use_next_candle
            c_pending_h := true
            c_pending_h_idx := bar_index
            c_pending_l := true
            c_pending_l_idx := bar_index
        else
            c_body_h := math.max(mtf_open, mtf_close)
            c_body_l := math.min(mtf_open, mtf_close)
    else
        if high >= c_h
            c_h := high
            c_h_idx := bar_index
            if use_next_candle
                c_pending_h := true
                c_pending_h_idx := bar_index
            else
                c_body_h := math.max(mtf_open, mtf_close)
        if low <= c_l
            c_l := low
            c_l_idx := bar_index
            if use_next_candle
                c_pending_l := true
                c_pending_l_idx := bar_index
            else
                c_body_l := math.min(mtf_open, mtf_close)

// --- RENDERING (exactly as original) ---
var line l_pmh = na,  var line l_pml = na
var line l_ydh = na,  var line l_ydl = na
var line l_dbyh = na, var line l_dbyl = na
var box b_ydh = na,   var box b_ydl = na
var box b_dbyh = na,  var box b_dbyl = na
var label lbl_pmh = na, var label lbl_pml = na
var label lbl_ydh = na, var label lbl_ydl = na
var label lbl_dbyh = na, var label lbl_dbyl = na

line.delete(l_pmh), line.delete(l_pml)
line.delete(l_ydh), line.delete(l_ydl)
line.delete(l_dbyh), line.delete(l_dbyl)
box.delete(b_ydh), box.delete(b_ydl)
box.delete(b_dbyh), box.delete(b_dbyl)
label.delete(lbl_pmh), label.delete(lbl_pml)
label.delete(lbl_ydh), label.delete(lbl_ydl)
label.delete(lbl_dbyh), label.delete(lbl_dbyl)

c_none = color.new(color.white, 100)
c_yd_bg = color.new(yd_color, zone_transp)
c_dby_bg = color.new(dby_color, zone_transp)
label_x = bar_index + 5

f_get_label(_txt, _val) => _txt + ": " + str.tostring(_val, format.mintick)

// --- Draw DBY ---
if show_dby and not na(dby_h)
    l_dbyh := line.new(dby_h_idx, dby_h, label_x, dby_h, color=dby_color, width=1)
    b_dbyh := box.new(dby_h_idx, dby_h, label_x, dby_body_h, bgcolor=c_dby_bg, border_color=c_none)
    lbl_dbyh := label.new(label_x, dby_h, f_get_label("DBPH", dby_h), color=c_none, textcolor=dby_color, style=label.style_label_left)
    l_dbyl := line.new(dby_l_idx, dby_l, label_x, dby_l, color=dby_color, width=1)
    b_dbyl := box.new(dby_l_idx, dby_l, label_x, dby_body_l, bgcolor=c_dby_bg, border_color=c_none)
    lbl_dbyl := label.new(label_x, dby_l, f_get_label("DBPL", dby_l), color=c_none, textcolor=dby_color, style=label.style_label_left)

// --- Draw Yesterday ---
if show_yd and not na(y_h)
    l_ydh := line.new(y_h_idx, y_h, label_x, y_h, color=yd_color, width=1)
    b_ydh := box.new(y_h_idx, y_h, label_x, y_body_h, bgcolor=c_yd_bg, border_color=c_none)
    lbl_ydh := label.new(label_x, y_h, f_get_label("PDH", y_h), color=c_none, textcolor=yd_color, style=label.style_label_left)
    l_ydl := line.new(y_l_idx, y_l, label_x, y_l, color=yd_color, width=1)
    b_ydl := box.new(y_l_idx, y_l, label_x, y_body_l, bgcolor=c_yd_bg, border_color=c_none)
    lbl_ydl := label.new(label_x, y_l, f_get_label("PDL", y_l), color=c_none, textcolor=yd_color, style=label.style_label_left)

// --- Draw Premarket ---
if show_pm and not na(pm_h)
    l_pmh := line.new(pm_h_idx, pm_h, label_x, pm_h, color=pm_color, width=1, style=line.style_dotted)
    lbl_pmh := label.new(label_x, pm_h, f_get_label("PMH", pm_h), color=c_none, textcolor=pm_color, style=label.style_label_left)
    l_pml := line.new(pm_l_idx, pm_l, label_x, pm_l, color=pm_color, width=1, style=line.style_dotted)
    lbl_pml := label.new(label_x, pm_l, f_get_label("PML", pm_l), color=c_none, textcolor=pm_color, style=label.style_label_left)