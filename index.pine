//@version=5
indicator("Casey's Strategy implemented by SaadPro", overlay=true, max_boxes_count=500, max_lines_count=500)

// --- Inputs ---
pm_session = input.session("0400-0930", "Premarket Time")
yd_session = input.session("0930-1600", "Regular Session Time")
tf_input   = input.timeframe("15", "Zone Calculation Timeframe")

show_pm   = input.bool(true, "Show Premarket (PMH/L)")
show_yd   = input.bool(true, "Show Yesterday (PDH/L)")
show_dby  = input.bool(true, "Show Day Before Yesterday (DBPH/L)")

pm_color    = input.color(#4b0082, "Premarket Color")
yd_color    = input.color(color.green, "Yesterday Color")
dby_color   = input.color(color.aqua, "DBY Color")
zone_transp = input.int(85, "Zone Transparency", minval=0, maxval=100)

// --- Data ---
[mtf_high, mtf_low, mtf_open, mtf_close] = request.security(syminfo.tickerid, tf_input, [high, low, open, close], lookahead=barmerge.lookahead_on)

// --- Storage Variables ---
// Current Session Trackers
var float c_h = na, var int c_h_idx = na, var float c_body_h = na
var float c_l = na, var int c_l_idx = na, var float c_body_l = na

// Yesterday (PDH/L) - Thursday if today is Friday
var float y_h = na, var int y_h_idx = na, var float y_body_h = na
var float y_l = na, var int y_l_idx = na, var float y_body_l = na

// Day Before (DBPH/L) - Wednesday if today is Friday
var float dby_h = na, var int dby_h_idx = na, var float dby_body_h = na
var float dby_l = na, var int dby_l_idx = na, var float dby_body_l = na

// Premarket
var float pm_h = na, var int pm_h_idx = na
var float pm_l = na, var int pm_l_idx = na

// --- Logic ---
is_pm = not na(time(timeframe.period, pm_session, "America/New_York"))
is_yd = not na(time(timeframe.period, yd_session, "America/New_York"))

// 1. Premarket Logic
if is_pm
    if not is_pm[1]
        pm_h := high, pm_h_idx := bar_index
        pm_l := low,  pm_l_idx := bar_index
    else
        if high >= pm_h
            pm_h := high, pm_h_idx := bar_index
        if low <= pm_l
            pm_l := low,  pm_l_idx := bar_index

// 2. Main Session Logic & Shifting
if is_yd
    if not is_yd[1]
        // AT 09:30 AM (New Session Start):
        // First: Move Yesterday's data to Day Before Yesterday (Wednesday becomes DBY)
        dby_h := y_h, dby_h_idx := y_h_idx, dby_body_h := y_body_h
        dby_l := y_l, dby_l_idx := y_l_idx, dby_body_l := y_body_l
        
        // Second: Move the just-finished session's data to Yesterday (Thursday becomes Yesterday)
        y_h := c_h, y_h_idx := c_h_idx, y_body_h := c_body_h
        y_l := c_l, y_l_idx := c_l_idx, y_body_l := c_body_l
        
        // Third: Reset Current Session for today (Friday)
        c_h := high, c_h_idx := bar_index, c_body_h := math.max(mtf_open, mtf_close)
        c_l := low,  c_l_idx := bar_index, c_body_l := math.min(mtf_open, mtf_close)
    else
        // Update today's tracking
        if high >= c_h
            c_h := high, c_h_idx := bar_index, c_body_h := math.max(mtf_open, mtf_close)
        if low <= c_l
            c_l := low,  c_l_idx := bar_index, c_body_l := math.min(mtf_open, mtf_close)

// --- Rendering ---
var line l_pmh = na,  var line l_pml = na
var line l_ydh = na,  var line l_ydl = na
var line l_dbyh = na, var line l_dbyl = na
var box b_ydh = na,   var box b_ydl = na
var box b_dbyh = na,  var box b_dbyl = na

line.delete(l_pmh), line.delete(l_pml)
line.delete(l_ydh), line.delete(l_ydl)
line.delete(l_dbyh), line.delete(l_dbyl)
box.delete(b_ydh), box.delete(b_ydl)
box.delete(b_dbyh), box.delete(b_dbyl)

// Colors
c_none = color.new(color.white, 100)
c_yd_bg = color.new(yd_color, zone_transp)
c_dby_bg = color.new(dby_color, zone_transp)

// Draw DBY (Wednesday)
if show_dby and not na(dby_h)
    l_dbyh := line.new(dby_h_idx, dby_h, bar_index + 5, dby_h, color=dby_color, width=3)
    b_dbyh := box.new(dby_h_idx, dby_h, bar_index + 5, dby_body_h, bgcolor=c_dby_bg, border_color=c_none)
    l_dbyl := line.new(dby_l_idx, dby_l, bar_index + 5, dby_l, color=dby_color, width=3)
    b_dbyl := box.new(dby_l_idx, dby_l, bar_index + 5, dby_body_l, bgcolor=c_dby_bg, border_color=c_none)

// Draw Yesterday (Thursday)
if show_yd and not na(y_h)
    l_ydh := line.new(y_h_idx, y_h, bar_index + 5, y_h, color=yd_color, width=3)
    b_ydh := box.new(y_h_idx, y_h, bar_index + 5, y_body_h, bgcolor=c_yd_bg, border_color=c_none)
    l_ydl := line.new(y_l_idx, y_l, bar_index + 5, y_l, color=yd_color, width=3)
    b_ydl := box.new(y_l_idx, y_l, bar_index + 5, y_body_l, bgcolor=c_yd_bg, border_color=c_none)

// Draw PM
if show_pm and not na(pm_h)
    l_pmh := line.new(pm_h_idx, pm_h, bar_index + 5, pm_h, color=pm_color, width=3)
    l_pml := line.new(pm_l_idx, pm_l, bar_index + 5, pm_l, color=pm_color, width=3)